<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.10.0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>cmf: Solute transport (1D)</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
    </script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cmf-logo-2018.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
  <div id="projectnumber">2.0.0b10</div>
   <div id="projectbrief">catchment modelling framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('cmf_tut_solute_transport1_d.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Solute transport (1D)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="cmf_tut1d.html">back...</a></p>
<h1>1D Richards equation model with tracer transport</h1>
<p>In this tutorial, we will introduce tracer in the 1D column model from the <a class="el" href="cmf_tut1d.html">last tutorial</a>. Tracer transport in cmf is up to now only advective using the equations given <a href="wiki:FiniteVolumeMethod#solutetransport">here</a>.</p>
<p>The amount of a tracer in a water storage is stored in another state variable, the <a class="el" href="classcmf_1_1water_1_1_solute_storage.html">SoluteStorage</a>. Solute storages are created automatically with their corresponding water storages, when the tracer is installed at project creation. For this example, we will use three tracers, X, Y and Z.</p>
<h3>Creating a project with tracer</h3>
<div class="fragment"><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division, print_function  <span class="comment"># Python 2/3 compatible code</span></div>
<div class="line"><span class="keyword">import</span> cmf</div>
<div class="line"><span class="comment"># Create project with space delimited tracer names</span></div>
<div class="line">p = <a class="code hl_class" href="classcmf_1_1project.html">cmf.project</a>(<span class="stringliteral">&#39;X Y Z&#39;</span>)</div>
<div class="line"><span class="comment"># Get the tracers as variables</span></div>
<div class="line">X,Y,Z = p.solutes</div>
<div class="ttc" id="aclasscmf_1_1project_html"><div class="ttname"><a href="classcmf_1_1project.html">cmf::project</a></div><div class="ttdoc">The study area, holding all cells, outlets and streams.</div><div class="ttdef"><b>Definition</b> project.h:53</div></div>
</div><!-- fragment --><h3>Setting up the 1D column model</h3>
<p>Now we set up the simple 1D column model from the <a class="el" href="cmf_tut1d.html">last</a>tutorial" with a constant rainfall rate. For every water
storage that is created, three solute storages are created
automatically:

@icode{py} 

# Create a single cell c with a surfacewater storage, which references 3 solute storages
c = p.NewCell(0,0,0,1000,with_surfacewater = True)
# Create 50 layers with 2cm thickness
for i in range(50):
    # Add a layer. Each layer will reference 3 solute storages
    c.add_layer((i+1)*0.02, cmf.VanGenuchtenMualem())
# Use Richards equation
c.install_connection(cmf.Richards)
# Use a constant rainfall of 100 mm to wash out the tracers fast
c.set_rainfall(100.)
# Make a groundwater boundary condition
gw = p.NewOutlet('gw',0,0,-1.5)
cmf.Richards(c.layers[-1],gw)
@endicode 

&lt;h2&gt;Solving a system with tracer transport&lt;/h2&gt;

There are two possibilities to solve a system with tracer transport:

1\. Solving the whole system as one including the water storages and the
solute storages as state variables 1. Use one solver for the water
transport and one solver for each tracer.

&lt;h3&gt;1\. One solver&lt;/h3&gt;

Since our system is stiff (see @ref cmfTutSolver "here" and @ref cmfTut1d "last tutorial") the best choice is the CVode solver. The setup
is simple:

@icode{py} 

solver = cmf.CVodeKrylov(p, 1e-9)
print(solver.size())
@endicode 

The print command shows, that the system to be solved is for a single
soil column quite big (&lt;tt&gt;(50 soillayers + 1 surface water storage)\\*(1
water storage + 3 solute storages) = 204 storages&lt;/tt&gt;). A second problem
with this approach is, that closely related storages (soillayers) are
not directly beneath each other in the list of storages. This makes the
numerical solution of the system much more computational demanding.
However, the error checking capabilities of the solver is used for the
whole system, thus the result is numerically reliable.

&lt;h3&gt;2\. Seperated solvers for water and tracers&lt;/h3&gt;

The setup for seperated solvers is only a bit more complicated, if one
uses the
@ref cmf::math::SoluteWaterIntegrator "SoluteWaterIntegrator" (SWI
for further use). The SWI implements the interface of cmf integrators,
but uses in our case for solvers internally, one for the water
transport, and 3 for the 3 tracers. The SWI is created using a template
for the water solver and one template for the solute solvers. When the
SWI should integrate over a given timespan (eg. one hour), the water
integrator is run first for a single timestep, that might be shorter
than one hour for convergence reasons. Then the solute sovers are run
after that for the same timestep. Since the boundary conditions of the
solute system change at each time step by the water transport, multistep
methods, like CVode or @ref cmf::math::BDF2 "BDF2" need to be reset
at each internal timestep. Hence, single step methods, like
@ref cmf::math::ImplicitEuler "ImplicitEuler" are a good choice for the solute transport. However, you encouraged to do your own tests with different solvers.</p>
<p>Be aware, when doing such an operator split, the error tolerance given for each solver is not globally valid, the numerical error for the whole system will be larger. In general, the numerical dispersion of tracers seem to increase a bit by using a SWI instead of a single solver for the whole system.</p>
<div class="fragment"><div class="line"><span class="comment"># Template for the water solver</span></div>
<div class="line">wsolver = cmf.CVodeKrylov(p,1e-9)</div>
<div class="line"><span class="comment"># Template for the solute solver</span></div>
<div class="line">ssolver = cmf.ImplicitEuler(p,1e-9)</div>
<div class="line"><span class="comment"># Creating the SWI, the storage objects of the project are internally assigned to the correct solver</span></div>
<div class="line">solver = cmf.SoluteWaterIntegrator(p.solutes, wsolver,ssolver,p)</div>
</div><!-- fragment --><h2>Run the model</h2>
<h3>Inital conditions</h3>
<p>As initial conditions, we use the hydrostatic equilibrium for 1.5 m groundwater level, and a solute concentration of 1 g/m3 for X in the first layer, 1 g/m3 for Y in the 10th layer, 1g/m3 for Z in the 20th layer</p>
<div class="fragment"><div class="line">c.saturated_depth = 1.5</div>
<div class="line">c.layers[0].conc(X,1.) c.layers[10].conc(Y,1.)</div>
<div class="line">c.layers[20].conc(Z,1.)</div>
</div><!-- fragment --><h3>Run the model</h3>
<p>The model runtime can be like this:</p>
<div class="fragment"><div class="line"><span class="comment"># Save wetness and concentration of all layers</span></div>
<div class="line">conc = [] wetness = []</div>
<div class="line"><span class="comment"># save groundwater recharge</span></div>
<div class="line">recharge=[]</div>
<div class="line"><span class="comment"># save concentration of recharge</span></div>
<div class="line">crecharge=[]</div>
<div class="line"><span class="comment"># Run for one week with hourly time step</span></div>
<div class="line"><span class="keywordflow">for</span> t <span class="keywordflow">in</span> solver.run(solver.t,solver.t + cmf.week,cmf.h):</div>
<div class="line">    <span class="comment"># Get concentration of all layers</span></div>
<div class="line">    conc.append([[l.conc(T) <span class="keywordflow">for</span> T <span class="keywordflow">in</span> p.solutes] <span class="keywordflow">for</span> l <span class="keywordflow">in</span> c.layers])</div>
<div class="line">    wetness.append([l.wetness <span class="keywordflow">for</span> l <span class="keywordflow">in</span> c.layers])</div>
<div class="line">    <span class="comment"># Get water balance of groundwater</span></div>
<div class="line">    recharge.append(gw.waterbalance(t))</div>
<div class="line">    crecharge.append([gw.conc(t,T) <span class="keywordflow">for</span> T <span class="keywordflow">in</span> p.solutes])</div>
</div><!-- fragment --><h3>Plot results</h3>
<p>The results should show 5 subplots. The first shows the recharge and the concentration of the recharge, the second the soil moisture distribution and the third to fifth the concentration distribution over time. The x axis shows always time.</p>
<div class="fragment"><div class="line"><span class="comment"># Plot the result</span></div>
<div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">import</span> pylab <span class="keyword">as</span> plt</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Plot gw recharge and its concentration</span></div>
<div class="line">ax1 = plt.subplot(511)</div>
<div class="line">plt.plot(recharge,<span class="stringliteral">&#39;k:&#39;</span>,lw=2)</div>
<div class="line">plt.legend([<span class="stringliteral">&#39;water&#39;</span>],loc=2)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&#39;recharge in mm/day&#39;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Plot concentration of recharge in the same plot</span></div>
<div class="line">plt.twinx()</div>
<div class="line">plt.plot(crecharge)</div>
<div class="line">plt.legend([<span class="stringliteral">&#39;X&#39;</span>,<span class="stringliteral">&#39;Y&#39;</span>,<span class="stringliteral">&#39;Z&#39;</span>],loc=1)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&#39;Conc. in g/m3&#39;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Plot wetness profile over time</span></div>
<div class="line">plt.subplot(512,sharex=ax1)</div>
<div class="line">plt.imshow(np.transpose(wetness),cmap=plt.cm.jet_r,aspect=<span class="stringliteral">&#39;auto&#39;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&#39;wetness&#39;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Plot concentration profiles over time. To see more, the color scale is limited to 0.1 g/m3.</span></div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3):</div>
<div class="line">    plt.subplot(513+i,sharex=ax1)</div>
<div class="line">    plt.imshow(np.transpose(conc)[i],cmap=plt.cm.copper,aspect=<span class="stringliteral">&#39;auto&#39;</span>,vmax=0.1)     plt.ylabel(p.solutes[i])</div>
<div class="line">plt.show()    </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<hr class="footer"/><address class="footer"><small>
<div>&copy 2008-2017 by 
<a class="el" href="http://www.uni-giessen.de/hydro/kraft"> Philipp Kraft</a> and
<a class="el" href="http://www.uni-giessen.de/hydro"> 
Institute of Landscape Ecology and Resources Management,University of Gie&szlig;en</a>
</h3></td>
<td>Generated: Fri Jan 19 2024 16:10:56</td>
</tr></table>
</small></address>
</body>
</html>
