<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cmf: Let it flow... the first cmf model</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cmf-logo-klein.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cmf
   &#160;<span id="projectnumber">1.3.1a0</span>
   </div>
   <div id="projectbrief">The Catchment Modelling Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">index</a></li><li class="navelem"><a class="el" href="tutorial.html">Tutorial</a></li><li class="navelem"><a class="el" href="gettingstarted.html">Understand the basic usage of cmf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Let it flow... the first cmf model </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="cmf_tut_boundary.html">next...</a></p>
<p>In this part, we are going to create a first model. To keep things simple, the model will be extremely simple. In fact, it would be easier to do this model in a spread sheet and keep cmf out of it. But of course it is to introduce some of the elements of cmf.</p>
<h2>The model</h2>
<p>The model is a simple linear storage equation to transport water from one water storage (W,,1,,) to another water storage (W,,2,,).</p>
<p class="formulaDsp">
\[ q_{W_1,W_2}=\frac{V_1}{t_r} \]
</p>
<p>where:</p>
<ul>
<li>\(q\) is the flux in \(\frac {m^3}{day}\) from W,,1,, to W,,2,,</li>
<li>\(V_1\) is the stored volume of water in W,,1,, in \(m^3\)</li>
<li>\(t_r\) is the mean residence time of the water in W,,1,, in days.</li>
</ul>
<h2>Implementation</h2>
<p>The model (without the solver) is set up with the following lines of code:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> cmf</div><div class="line">p = <a class="code" href="classcmf_1_1project.html">cmf.project</a>()</div><div class="line"><span class="comment"># Create W1 in project p </span></div><div class="line">W1 = p.NewStorage(name=<span class="stringliteral">&quot;W1&quot;</span>,x=0,y=0,z=0)</div><div class="line"><span class="comment"># Create W2 in project p without any volume as an initial state</span></div><div class="line">W2 = p.NewStorage(name=<span class="stringliteral">&quot;W2&quot;</span>,x=10,y=0,z=0)</div><div class="line"><span class="comment"># Create a linear storage equation from W1 to W2 with a residence time tr of one day</span></div><div class="line">q = cmf.kinematic_wave(source=W1,target=W2,residencetime=1.0)</div><div class="line"><span class="comment"># Set the initial state of w1 to 1mÂ³ of water.</span></div><div class="line">W1.volume = 1.0</div></div><!-- fragment --><h2>The ordinary differential equation (ODE) system</h2>
<h3>Formulation</h3>
<p>With these lines the ODE (ordinary differential equation) system is formulated:</p>
<p class="formulaDsp">
\[ \frac{dV_1}{dt} = -\frac{V_1}{t_r} \]
</p>
<p class="formulaDsp">
\[ \frac{dV_2}{dt} = \frac{V_1}{t_r} \]
</p>
<h3>Solving the system</h3>
<p>Due to the simplicity of the model, it can be integrated analytically.</p>
<p class="formulaDsp">
\[ V_1(t) = V_1(t_0) e^{-t/t_r} \]
</p>
<p class="formulaDsp">
\[ V_2(t) = V_1(t_0) (1-e^{-t/t_r}) \]
</p>
<p>But it is of course only a proxy model. For more interesting models with stochastic boundary conditions, we need to use a numerical solution. For numerical time integration any of the time integration schemes of cmf will do for this model. If you are using more complex models with very different velocities, error controlled and implicit solvers are necessary.</p>
<h3>Implementing the numerical solution</h3>
<p>To integrate our simple system in time, we create an integrator, for example an explicit 4/5 step Runge-Kutta-Fehlberg integrator, the <a class="el" href="classcmf_1_1math_1_1_r_k_f_integrator.html">RKFIntegrator</a> (other integrators are available, see later parts in the tutorial)</p>
<div class="fragment"><div class="line"><span class="comment"># Create an integrator for the ODE represented by project p, with an error tolerance of 1e-9</span></div><div class="line">solver = cmf.RKFIntegrator(p,1e-9)</div><div class="line"><span class="comment"># Import Python&#39;s datetime module</span></div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"><span class="comment"># Set the intitial time of the solver</span></div><div class="line">solver.t = datetime.datetime(2012,1,1)</div></div><!-- fragment --><p>The code above is the setup part. Every cmf model consists of a setup part, where the hydrological system is defined. For larger models, Python's looping and conditional syntax and the possibility to read nearly any data format can help to define the system from data.</p>
<h2>Running the system</h2>
<p>Now we have all parts of our model available to run it. The solver can be advanced for a certain time step using solver.integrate(dt), where dt is a time step. After the integration the states and fluxes of the model can be queried (see <a class="el" href="cmf_tut_fluxes.html">Query fluxes and storages</a>) and, if needed, saved into a file. Or you can store the results in a Python list or a cmf timeseries and use <a href="http://matplotlib.org">matplotlib</a> to plot the results immediately after running the model. The content and format of output is completely up to the user, some experience in writing and reading files with Python is therefore a prerequisite to design your own output.</p>
<p>In this example, we will write a csv file with the timestep, the state of w1 and the state of w2.</p>
<div class="fragment"><div class="line"><span class="comment"># Create a csv file on disk for output, and write column headers</span></div><div class="line">fout = open(<span class="stringliteral">&#39;firstmodel.csv&#39;</span>,<span class="stringliteral">&#39;w&#39;</span>)</div><div class="line">fout.write(<span class="stringliteral">&#39;time,w1.volume m3,w2.volume m3\n&#39;</span>)</div><div class="line"><span class="comment"># Run the model for 7 days, using a while loop</span></div><div class="line"><span class="keywordflow">while</span> solver.t &lt; datetime.datetime(2012,1,7):</div><div class="line">    <span class="comment"># integrate the system for 1 h</span></div><div class="line">    solver.integrate_until(solver.t + datetime.timedelta(hours=1))</div><div class="line">    <span class="comment"># write output (using the format operator %)</span></div><div class="line">    fout.write(<span class="stringliteral">&#39;{t},{w1:0.4f},{w2:0.4f}\n&#39;</span>.format(t=solver.t,w1=W1.volume,w2=W2.volume))</div><div class="line">fout.close()</div></div><!-- fragment --><p>In principle, this is the base for all cmf models. In the next chapters, we will introduce boundary conditions, more specialized water storages, like soil layers and rivers, and have a look at solute transport.</p>
<h2>Alternative run time loop for plotting</h2>
<p>An <b>alternative</b> way to the run time code above is using <a href="http://docs.python.org/3/tutorial/datastructures.html">list comprehension</a>. The result is then not written into a file, but stored in memory using a list. This list can be plotted using the <code>pylab</code>-API of <a href="http://matplotlib.org">matplotlib</a>. The setup code is as before.</p>
<div class="fragment"><div class="line"><span class="comment"># Iterate the solver hourly through the time range and return for each time step the volume in W1 and W2</span></div><div class="line">result = [[W1.volume,W2.volume] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> solver.run(datetime.datetime(2012,1,1),datetime.datetime(2012,1,7),datetime.timedelta(hours=1))]</div><div class="line"><span class="keyword">import</span> pylab <span class="keyword">as</span> plt</div><div class="line">plt.plot(result)</div><div class="line">plt.xlabel(<span class="stringliteral">&#39;hours&#39;</span>)</div><div class="line">plt.ylabel(<span class="stringliteral">&#39;Volume in $m^3$&#39;</span>)</div><div class="line">plt.legend((<span class="stringliteral">&#39;W1&#39;</span>,<span class="stringliteral">&#39;W2&#39;</span>))</div></div><!-- fragment --><p>And this is the result:</p>
<div class="image">
<img src="CmfFirstModelTut.png" alt="CmfFirstModelTut.png"/>
</div>
<p>Next step is to include <a class="el" href="cmf_tut_boundary.html">boundary conditions</a>. </p>
</div></div><!-- contents -->
<hr class="footer"/><address class="footer"><small>
<div>&copy 2008-2017 by 
<a class="el" href="http://www.uni-giessen.de/hydro/kraft"> Philipp Kraft</a> and
<a class="el" href="http://www.uni-giessen.de/hydro"> 
Institute of Landscape Ecology and Resources Management,University of Gie&szlig;en</a>
</h3></td>
<td>Generated: Wed May 9 2018 13:52:57</td>
</tr></table>
</small></address>
</body>
</html>
