<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.10.0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>cmf: Query fluxes and states</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
    </script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cmf-logo-2018.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
  <div id="projectnumber">2.0.0b10</div>
   <div id="projectbrief">catchment modelling framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('cmf_tut_fluxes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Query fluxes and states</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="cmf_tut_boundary.html">back...</a> <a class="el" href="cmf_tut_solver.html">next...</a></p>
<p>Every flux and every state can be accessed during runtime. Thus you can save anything you like to the output during the run time loop. In the following we will have a look at some techniques how to see what is going on in a model. As an example model we use the very simple 2 storage model with boundary condition from CmfTutBoundary.</p>
<h2>Note for Python 2 users</h2>
<p>To show our results, we are using Python's print statement / function. However, "print" has changed between python 2 and 3. To run our examples python 2 users should always start their programs with the following line:</p>
<div class="fragment"><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function, division</div>
</div><!-- fragment --><p>This import the behaviour of the python3 print function as well as the improved handling of integer division into python 2. Using this line in python3 is fine and changes nothing.</p>
<h2>Getting states</h2>
<p>We have already asked for states in the example model. Every water storage has the property <code>volume</code> to return the stored water volume in mÂ³. More general, <code>state</code> returns the value stored in a state variable, which is usually <code>volume</code> for a water storage and the tracer mass for a solute storage. Water storages with a defined relation between head and volume (such storages will be covered later, eg. <a class="el" href="classcmf_1_1upslope_1_1_soil_layer.html">SoilLayer</a> and <a class="el" href="classcmf_1_1river_1_1_open_water_storage.html">OpenWaterStorage</a>), can also give back their <code>potential</code>.</p>
<div class="fragment"><div class="line">print(W1.volume)</div>
<div class="line">print(W1.state)</div>
</div><!-- fragment --><p>The properties can also be used to change the states of the system, but this is only useful for initial conditions. Changing the state during runtime will of course destroy the water balance. Some of the <a class="el" href="cmf_tut_solver.html">solvers</a> will even ignore the changes if they are not reset. In our <a class="el" href="cmf_tut_first_model.html">simple example</a> we have used this already for the initial condition:</p>
<div class="fragment"><div class="line">W1.volume = 1.0</div>
</div><!-- fragment --><h2>Getting fluxes</h2>
<h3>Fluxes between two nodes</h3>
<p>Getting fluxes is a little bit more complicated than getting states: Some fluxes depend only on the state of the connected water storages, like <code>LinearStorageConnection</code>, some on time, like the <a class="el" href="classcmf_1_1water_1_1_neumann_boundary.html">NeumannBoundary</a> and some on both. Since the storages / nodes do not know, what time we have (this is a property of the solver) you need to give the time into the query.</p>
<p>Fluxes between two nodes <code>source</code> and <code>target</code> at time <code>t</code> can be queried with the <code>flux_to</code> method:</p>
<div class="fragment"><div class="line">source.flux_to(target,t)</div>
</div><!-- fragment --><p>For our toy model you can query all fluxes the following way:</p>
<div class="fragment"><div class="line"><span class="comment"># get the current time</span></div>
<div class="line">t = solver.t</div>
<div class="line"><span class="comment"># Prints the fluxes in the model</span></div>
<div class="line">print(<span class="stringliteral">&#39;In-&gt;&#39;</span>,In.flux_to(W1,t),<span class="stringliteral">&#39;-&gt;W1-&gt;&#39;</span>,W1.flux_to(W2,t),<span class="stringliteral">&#39;-&gt;W2-&gt;&#39;</span>,W2.flux_to(Out,t))</div>
</div><!-- fragment --><p>You get the result of the <b>actual</b> flux between source and target in \(m^3/day\). If water is flowing from source to target, the result is positive else negative. If source and target are not connected you will get 0.0, and no error will occur. Since you get the actual flux, summing up the fluxes does not necessarily reflect the true accumulated flux, since in non-linear models, the integrated flux over a timestep does not equal the sum. CMF is very mass conservative, since the water volume is the integrated state variable, but by summing up you might get the impression of numerical errors in the integration.</p>
<div class="image">
<img src="cmfTutFluxes.png" alt=""/>
</div>
    <p>Now we are going to save the fluxes instead of the volume in a list in our <a class="el" href="cmf_tut_boundary.html">first model with boundary conditions</a> and plot the result:</p>
<div class="fragment"><div class="line"><span class="comment"># Iterate the solver hourly through the time range </span></div>
<div class="line"><span class="comment"># and return for each time step the fluxes between the nodes</span></div>
<div class="line">result = [[In.flux_to(W1,t),W1.flux_to(W2,t),W2.flux_to(Out,t)] </div>
<div class="line">          <span class="keywordflow">for</span> t <span class="keywordflow">in</span> solver.run(datetime.datetime(2012,1,1),</div>
<div class="line">                              datetime.datetime(2012,1,7),</div>
<div class="line">                              datetime.timedelta(hours=1))]</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Plot the result</span></div>
<div class="line"><span class="keyword">import</span> pylab <span class="keyword">as</span> plt</div>
<div class="line">plt.plot(result)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&#39;hours&#39;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&#39;flux in $m^3/day$&#39;</span>)</div>
<div class="line">plt.legend((<span class="stringliteral">&#39;In-&gt;W1&#39;</span>,<span class="stringliteral">&#39;W1-&gt;W2&#39;</span>,<span class="stringliteral">&#39;W2-&gt;Out&#39;</span>))</div>
<div class="line">plt.show()</div>
</div><!-- fragment --><p>The result of this code is on the right.</p>
<h3>All fluxes in and out of one node</h3>
<p>You can get all fluxes of one node with <code>target.fluxes(t)</code>. You get a list of tuples, each tuple composed of the flux and the target node. <b>Note:</b> positive fluxes here mean fluxes into the target.</p>
<p>Example:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> flux,node <span class="keywordflow">in</span> W1.fluxes(solver.t):</div>
<div class="line">    print(<span class="stringliteral">&#39;%4.1f m3/day from %s&#39;</span> % (flux,node))</div>
</div><!-- fragment --><p>Returns:</p>
<div class="fragment"><div class="line">-1.0 m3/day from {W2}                                                                                                                      </div>
<div class="line"> 0.0 m3/day from {Boundary at W1}    </div>
</div><!-- fragment --><h3>Getting the waterbalance of a node</h3>
<p>If you want to know the current balance (sum) of the fluxes you can of course do:</p>
<div class="fragment"><div class="line">wb = sum(flux <span class="keywordflow">for</span> flux,node <span class="keywordflow">in</span> W1.fluxes(solver.t))</div>
</div><!-- fragment --><p>But you can also let cmf do the sum:</p>
<div class="fragment"><div class="line">wb = W1.waterbalance(solver.t)</div>
</div><!-- fragment --><p>or even shorter:</p>
<div class="fragment"><div class="line">wb = W1(solver.t)</div>
</div><!-- fragment --><p>This is especially useful for boundary conditions, however this does also only show the <b>actual</b> waterbalance and not the average waterbalance over a given timestep. Hence accumulating the waterbalance over time leads to numerical errors.</p>
<p>If you need the exact waterbalance, you can create another waterstorage and connect the boundary condition with an <a class="el" href="classcmf_1_1water_1_1_waterbalance_flux.html">WaterbalanceFlux</a></p>
<h2>Inspect your hydrological network</h2>
<p>Sometimes, you might not be sure what storages are exactly connected to each other, or the following tools are just simpler to use, then inspecting your setup code.</p>
<p>Getting a list of all the connections of one node is done by the <code>connections</code> property of a node (storage, boundary).</p>
<p>Example:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> con <span class="keywordflow">in</span> W1.connections:</div>
<div class="line">    print(con)</div>
</div><!-- fragment --><p>prints: </p><pre class="fragment">kinematic wave({W1}&lt;-&gt;{W2})
Neumann boundary flux({Boundary at W1}&lt;-&gt;{W1})
</pre><p> <code>connected_nodes</code> is a list of the nodes that are connected to another.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> node <span class="keywordflow">in</span> W1.connected_nodes:</div>
<div class="line">    print(node)</div>
</div><!-- fragment --><p>prints: </p><pre class="fragment">{W2}
{Boundary at W1}
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<hr class="footer"/><address class="footer"><small>
<div>&copy 2008-2017 by 
<a class="el" href="http://www.uni-giessen.de/hydro/kraft"> Philipp Kraft</a> and
<a class="el" href="http://www.uni-giessen.de/hydro"> 
Institute of Landscape Ecology and Resources Management,University of Gie&szlig;en</a>
</h3></td>
<td>Generated: Fri Jan 19 2024 16:10:56</td>
</tr></table>
</small></address>
</body>
</html>
