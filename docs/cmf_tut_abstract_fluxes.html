<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.10.0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>cmf: Abstract connections for advanced model concepts</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
    </script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cmf-logo-2018.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
  <div id="projectnumber">2.0.0b10</div>
   <div id="projectbrief">catchment modelling framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('cmf_tut_abstract_fluxes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Abstract connections for advanced model concepts</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Depending on your model design, you might need to use rather abstract concepts can help to realize your model - but not every model needs these connections.</p>
<p>The class names of these connections are not very good and <b>will be changed</b> in CMF 2.0. Starting with cmf 1.4 the new names are already available</p>
<h2>Balancing water flux at one node</h2>
<h3>What does it mean?</h3>
<p>The <a class="el" href="classcmf_1_1water_1_1_waterbalance_flux.html">WaterbalanceFlux</a> is a connection to route the water balance of a node somewhere else. The connection checks the flux over all other connections of the <em>left</em> node and routes any surplus to the <em>right</em> node, or in case of a negative water balance of the <em>left</em> node, additional water is fetched from the right node. Or as a mathematical expression:</p>
<p class="formulaDsp">
\[
q_{N} = -\sum_{i=1}^{N-1} q_{j}(V, V_{j})
\]
</p>
<p>The water balance connection levels always all other fluxes out: The sum of all fluxes (including the water balance connection) is zero.</p>
<p class="formulaDsp">
\[
\sum_{i=1}^{N} q_{j}(V, V_{j}) = \frac{dV}{dt} = 0
\]
</p>
<p>Hence, there is often no need anymore to leave the left node a storage, since no state change can happen there due to the water balance connection. You should therefore consider to change your storage into a "non-storing" node, like a boundary condition. If your water balance connection connects to the surface of a cell, you can (in most cases) create the cell without surface water storage</p>
<h3>When do I want a water balance connection</h3>
<p>In practice, we found mainly two situations, when to use the water balance connection:</p>
<ol type="1">
<li>at the cell surface</li>
<li>to connect submodels</li>
</ol>
<p>However, a water balance connection might solve a problem for a totally new application of cmf, which we as the developers have not forseen. Be creative!</p>
<h4>At the cell surface</h4>
<p>When the user creates the first subsurface storage for a conceptual model with no surface water storage, this first layer is automatically connected with the surface via a water balance connection.</p>
<div class="fragment"><div class="line">p = <a class="code hl_class" href="classcmf_1_1project.html">cmf.project</a>()</div>
<div class="line"><span class="comment"># Create cell without surface water storage</span></div>
<div class="line">c = p.NewCell(0, 0, 0, 1000, with_surfacewater=<span class="keyword">False</span>)</div>
<div class="line">l = c.add_layer(1.0)  <span class="comment"># Add layer with 1000 mm capacity</span></div>
<div class="line">print(cmf.describe(c.surfacewater))</div>
<div class="ttc" id="aclasscmf_1_1project_html"><div class="ttname"><a href="classcmf_1_1project.html">cmf::project</a></div><div class="ttdoc">The study area, holding all cells, outlets and streams.</div><div class="ttdef"><b>Definition</b> project.h:53</div></div>
</div><!-- fragment --><p>results in:</p>
<ul>
<li>{Surface water of cell #0}:<ul>
<li>waterbalance connection({Surface water of cell #0}&lt;-&gt;{Layer #0 of cell #0})</li>
<li>Rainfall({Constant rainfall of 0 mm/day}&lt;-&gt;{Surface water of cell #0})</li>
</ul>
</li>
</ul>
<p>With this automatic construction, the mass balance of the system is ensured - no water can vanish at the surface node, which happens when the water balance of <code>c.surfacewater.waterbalance(t) != 0</code>.</p>
<p>If you choose to use an infiltration method that limits infiltration by saturation excess or hortonian overflow (e.g. <a class="el" href="simple_infiltration.html">ConceptualInfiltration</a>), and the cell surface is still no storage, the local mass balance on the surface is not necessary zero, and the excess gets lost. To route the surface water excess without time lag to a river or the catchment outlet (good approximation for time steps &gt; 1h), you can use the water balance connection again.</p>
<p>The following code is meant to expand the code snippet from above:</p>
<div class="fragment"><div class="line">cmf.ConceptualInfiltration(l, c.surfacewater)</div>
<div class="line"><span class="comment"># Create outlet</span></div>
<div class="line">out = p.NewOutlet(<span class="stringliteral">&#39;outlet&#39;</span>)</div>
<div class="line"><span class="comment"># moves all infiltration excess to the outlet</span></div>
<div class="line">cmf.WaterbalanceFlux(c.surfacewater, out)</div>
<div class="line">print(cmf.describe(c.surfacewater))</div>
</div><!-- fragment --><p>results in:</p>
<ul>
<li>{Surface water of cell #0}:<ul>
<li>waterbalance connection({Surface water of cell #0}&lt;-&gt;{outlet})</li>
<li>simple infiltration({Surface water of cell #0}&lt;-&gt;{Layer #0 of cell #0})</li>
<li>Rainfall({Constant rainfall of 0 mm/day}&lt;-&gt;{Surface water of cell #0})</li>
</ul>
</li>
</ul>
<h4>As a bridge between submodels</h4>
<p>If the second example for the surface does not point to an outlet but another part of the model setup, eg. a river, the water balance connection is the bridge between the local (cell) sub model and the distributing river network. You can also place a collection node between the submodels for simplified observation of fluxes between these different model domains.</p>
<h2>Keeping a flux constant as long as water is available</h2>
<div class="image">
<img src="CmfTutAbstractFluxes.png" alt=""/>
</div>
    <p>For some processes a constant flux from one water storage to another or a boundary condition is needed. These constant (but externally changeable) fluxes can be anthropogenic water fluxes, like the regulation of a dam or a pump rate, or some other process that has a flux limit. Eg. the model HBVlight assumes a constant percolation from the 1st to the 2nd groundwater storage. However, when the source becomes empty, the flux stops. To avoid a hard stop, the fluxes decreases linear to zero, when only volume for <code>decrease time</code> is left in the source storage.</p>
<p>Currently, this type of connection is called <a class="el" href="classcmf_1_1water_1_1_constant_flux.html">ConstantFlux</a>.</p>
<div class="fragment"><div class="line">p = <a class="code hl_class" href="classcmf_1_1project.html">cmf.project</a>()</div>
<div class="line">w = p.NewStorage(<span class="stringliteral">&#39;source&#39;</span>)</div>
<div class="line">o = p.NewOutlet(<span class="stringliteral">&#39;out&#39;</span>)</div>
<div class="line"><span class="keyword">import</span> pylab <span class="keyword">as</span> plt</div>
<div class="line"><span class="comment"># Add a constant flux</span></div>
<div class="line">constflux = cmf.ConstantFlux(w, o, 1.0, flux_decrease_time=cmf.day)</div>
<div class="line">w.volume = 2.0</div>
<div class="line">solver = cmf.RKFIntegrator(p)</div>
<div class="line">vol, flux = zip(*[(w.volume, w.flux_to(o, t)) </div>
<div class="line">                  <span class="keywordflow">for</span> t <span class="keywordflow">in</span> solver.run(cmf.Time(), cmf.day * 4, cmf.h)])</div>
<div class="line">plt.subplot(1, 2, 1)</div>
<div class="line">plt.plot(vol,color=<span class="stringliteral">&#39;r&#39;</span>, label=<span class="stringliteral">&#39;Volume&#39;</span>)</div>
<div class="line">plt.plot(flux,color=<span class="stringliteral">&#39;b&#39;</span>, label=<span class="stringliteral">&#39;flux&#39;</span>)</div>
<div class="line">plt.yticks([1], [<span class="stringliteral">&#39;$q_{max}$&#39;</span>])</div>
<div class="line">plt.xticks([24, 48, 72],[1, 2, 3])</div>
<div class="line">plt.xlabel(<span class="stringliteral">&#39;days&#39;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.subplot(1, 2, 2)</div>
<div class="line">plt.plot(vol, flux, <span class="stringliteral">&#39;kx&#39;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&#39;flux $m^3/day$&#39;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&#39;volume $m^3$&#39;</span>) </div>
</div><!-- fragment --><h2>Keeping a state constant as long as water is available</h2>
<p>This connection holds the state of a water storage constant getting or releasing water to the other node of the connection. The flux between the nodes is proportional to the difference between the state of the storage and the defined target state of the storage. This connection is called <a class="el" href="classcmf_1_1water_1_1_constant_state_flux.html">ConstantStateFlux</a>.</p>
<h2>Partitioning of a water flux calculated by another connection</h2>
<p><a class="el" href="classcmf_1_1water_1_1_partition_flux_route.html">PartitionFluxRoute</a> reads the flux between two nodes (source and target1) and routes a fraction of the actual flux to a third node (target2) immediately and without a time lag. The PartitioningFluxRoute connects target1 with target2 but gets the flux from the other connection.</p>
<p>This can be used for divides in the network, bypassing layers as in BROOK90 or leaky connections in conceptual models. Another option is to divide a water flux into a fast and slow path way. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<hr class="footer"/><address class="footer"><small>
<div>&copy 2008-2017 by 
<a class="el" href="http://www.uni-giessen.de/hydro/kraft"> Philipp Kraft</a> and
<a class="el" href="http://www.uni-giessen.de/hydro"> 
Institute of Landscape Ecology and Resources Management,University of Gie&szlig;en</a>
</h3></td>
<td>Generated: Fri Jan 19 2024 16:10:56</td>
</tr></table>
</small></address>
</body>
</html>
