<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cmf: The structure of a cmf program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cmf-logo-klein.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cmf
   &#160;<span id="projectnumber">1.3.1a0</span>
   </div>
   <div id="projectbrief">The Catchment Modelling Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">index</a></li><li class="navelem"><a class="el" href="tutorial.html">Tutorial</a></li><li class="navelem"><a class="el" href="gettingstarted.html">Understand the basic usage of cmf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The structure of a cmf program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial is still under development, sorry</p>
<p>To get a cmf program to do what you want, the order of creating the building blocks of cmf is of importance. <br />
 </p><h2>Programming style</h2>
<p>Python comes with some syntactic rules how a program works. But there are also not enforced rules, how a Python program should look like, the so called <a href="https://www.python.org/dev/peps/pep-0008/">PEP 8 style</a>. The cmf library does often not follow this style guide, but I wish knew it when I wrote cmf. <br />
 </p><h2>Simple CMF - scripts</h2>
<p>A simple cmf script is just a batch of commands. The only structures used are conditions (if) and loops (for / while). Such programs are very simple to understand and followed, if they are short and every reader will always be interested in every detail. This type of script is fine for the beginner, because the flow of the program is obvious: from top to bottom, like a normal text. When your program grows beyond 50 to 100 lines, take 10 minutes to restructure your program using functions or classes.</p>
<h3>Module docstring and shebang</h3>
<p>If you will ever run your model on a Linux / Unix system, it is a good idea to start the file with the so called shebang: </p><div class="fragment"><div class="line"><span class="comment">#! /usr/bin/env python3</span></div></div><!-- fragment --><p>Followed by a docstring explaining the purpose of your program:</p>
<div class="fragment"><div class="line"><span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><span class="stringliteral">This cmf program is written to demonstrate </span></div><div class="line"><span class="stringliteral">the structure of any other cmf program</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">:author: philippkraft (my Github user-name)</span></div><div class="line"><span class="stringliteral">:date: 2018-5-9 </span></div><div class="line"><span class="stringliteral">&quot;&quot;&quot;</span></div></div><!-- fragment --> <h3>Import</h3>
<p>To use cmf, the cmf-library must be imported. However, if you like to write code that is compatible for Python 2 and 3 the first line of your program is the <code>from __future__ import</code> line for Python 2 compatibility. If you need other libraries / packages in your program, import them also in the beginning. Avoid <code>from xxx import *</code> commands in all scripts.</p>
<p>The import section of a CMF script, that uses <code>numpy</code>-arrays and <code>matplotlib</code> plotting and <code>datetime</code>'s objects might look like:</p>
<div class="fragment"><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division, print_function, absolute_import</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pylab <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</div><div class="line"><span class="keyword">import</span> cmf</div></div><!-- fragment --><h3>Build setup</h3>
<p>The setup part of a cmf program is, where the structure of the cmf model is defined. The structure consists of the storages, boundary conditions and connections and for more advanced models also of the cells with soil layers and vegetation.</p>
<p>In the <a class="el" href="cmf_tut_boundary.html">Boundary conditions</a> example the setup part is, where the project, the two storages, the two boundary conditions and the connections are defined:</p>
<div class="fragment"><div class="line">p = <a class="code" href="classcmf_1_1project.html">cmf.project</a>()</div><div class="line">W1 = p.NewStorage(name=<span class="stringliteral">&quot;W1&quot;</span>,x=0,y=0,z=0)</div><div class="line">W2 = p.NewStorage(name=<span class="stringliteral">&quot;W2&quot;</span>,x=10,y=0,z=0)</div><div class="line">q = cmf.kinematic_wave(source=W1,target=W2,residencetime=1.0)</div><div class="line">b_out = p.NewOutlet(name=<span class="stringliteral">&quot;Outlet&quot;</span>,x=20,y=0,z=0)</div><div class="line">b_out_q = cmf.kinematic_wave(source=W2,target=b_out,residencetime=2.0)</div><div class="line"></div><div class="line"><span class="comment"># Create a Neumann Boundary condition connected to W1</span></div><div class="line">b_in = cmf.NeumannBoundary.create(W1)</div></div><!-- fragment --><h3>Assign driver data and initial values</h3>
<p>CMF models are run from an initial condition using forcing (or driver) data during runtime. The place between defining the structure of your model and creating a solver is a good place to overwrite the default initial state (that are not very well documented but are usually some kind of "empty") and load and assign forcing data.</p>
<p>In our case, the initial condition is the stored volume of <code>W1</code> and <code>W2</code> and the forcing data is the flux over the Neumann boundary condition.</p>
<div class="fragment"><div class="line">W1.volume = 1.0</div><div class="line">W2.volume = 0.0</div><div class="line">b_in.flux = cmf.timeseries(begin = datetime.datetime(2012,1,1), </div><div class="line">                           step = datetime.timedelta(days=1), </div><div class="line">                           interpolationmethod = 0)</div><div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(10):</div><div class="line">    <span class="comment"># Add 0.0 m3/day for even days, and 1.0 m3/day for odd days</span></div><div class="line">    b_in.flux.add(i % 2)</div></div><!-- fragment --><h3>Create solver</h3>
<p>The solver should only be created <b>after</b> the structure is setup, since solvers in cmf do not own a reference to a project, or what else, but only extract references to the state variables of a project, a cell or some other owner of state variables (<a class="el" href="cmf_software_objects.html">UML-diagram of the main cmf objects</a>). This means, if you create a solver and after that, you are going to extend your project with new storages, the solver knows nothing about these and the mass conversation of the model is broken. If you extend your project, eg. in an interactive environment, just make sure to create a new solver also.</p>
<div class="fragment"><div class="line">solver = cmf.ImplicitEuler(p, 1e-9)</div></div><!-- fragment --><h3>Runtime loop</h3>
<p>The solver is used to advance the model in the runtime loop. The runtime loop is user defined, to allow the user to interact with the running model in any way. Usages of the runtime loop include:</p>
<ul>
<li>Store any data from the model in files or in-memory collections (eg. lists, arrays, cmf.timeseries, pandas frames etc.)</li>
<li>Print model progress to screen</li>
<li>Visual animations of the model state (see cmf/demo/cmf2d.py)</li>
<li>Interact with other models as an operator split (<a class="el" href="publication_list.html">List of cmf publications</a>)</li>
</ul>
<p>To build the runtime loop, the generator method <code>run</code> of the solver makes the iteration over the model time simple:</p>
<div class="fragment"><div class="line">starttime = datetime(2018, 5, 9)</div><div class="line">endtime = datetime(2018, 7, 9)</div><div class="line">timestep = timedelta(hours=1)</div><div class="line"></div><div class="line">storage_volume = []</div><div class="line"></div><div class="line"><span class="keywordflow">for</span> t <span class="keywordflow">in</span> solver.run(starttime, endtime, timestep):</div><div class="line">    print(t)</div><div class="line">    storage_volume.append((W1.volume, W2.volume))</div></div><!-- fragment --><h2>Structuring your code</h2>
<p>Of course, writing the sections from above just down in the typical "script" style of programs, gets totally confusing when your program grows and needs more then 50-100 lines. Therefore, it is good practise to seperate your code into functions with a well defined scope. For an experienced programmer, that comes naturally, if you are new to programming, please read about structured programming. A simple structure using functions could look roughly like this:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> cmf</div><div class="line"></div><div class="line"><span class="keyword">def </span>create_project():</div><div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><span class="stringliteral">    Contains parts of the &quot;build setup&quot; section</span></div><div class="line"><span class="stringliteral">    &quot;&quot;&quot;</span></div><div class="line">    p = <a class="code" href="classcmf_1_1project.html">cmf.project</a>()</div><div class="line">    ws1 = p.NewStorage(<span class="stringliteral">&#39;W1&#39;</span>)</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> p, ws1</div><div class="line"></div><div class="line"><span class="keyword">def </span>add_boundaries(p):</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">return</span> b_in, b_out</div><div class="line"></div><div class="line"><span class="keyword">def </span>run(p, start, end):</div><div class="line">    ...</div><div class="line"></div><div class="line"><span class="keyword">def </span>plot_result(data):</div><div class="line">    ...</div></div><!-- fragment --><h2>CMF and SPOTPY</h2>
<p><a href="https://github.com/thouska/spotpy"><code>spotpy</code></a> by Tobias Houska is an ideal partner to calibrate cmf models. In fact, there is a cmf example in spotpy ( <a href="https://github.com/thouska/spotpy/blob/master/spotpy/examples/spot_setup_cmf_lumped.py">setup</a>, <a href="https://github.com/thouska/spotpy/blob/master/spotpy/examples/tutorial_cmf_lumped.py">tutorial</a>, <a href="https://github.com/thouska/spotpy/blob/master/spotpy/examples/gui_cmf_lumped.py">gui</a> )</p>
<p>You can see there, how</p><ul>
<li>to write a model class</li>
<li>you define parameters to calibrate</li>
<li>and how to seperate fixed structure (<code>__init__</code>), and parameter depending structure (<code>set_parameters</code>) </li>
</ul>
</div></div><!-- contents -->
<hr class="footer"/><address class="footer"><small>
<div>&copy 2008-2017 by 
<a class="el" href="http://www.uni-giessen.de/hydro/kraft"> Philipp Kraft</a> and
<a class="el" href="http://www.uni-giessen.de/hydro"> 
Institute of Landscape Ecology and Resources Management,University of Gie&szlig;en</a>
</h3></td>
<td>Generated: Wed May 9 2018 13:52:57</td>
</tr></table>
</small></address>
</body>
</html>
