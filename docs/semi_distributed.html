<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.10.0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>cmf: Semi distributed models in CMF</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
    </script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cmf-logo-2018.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
  <div id="projectnumber">2.0.0b10</div>
   <div id="projectbrief">catchment modelling framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('semi_distributed.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Semi distributed models in CMF</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Creating a lumped and a semi distributed model in CMF can be handled relatively similar. The main difference is that a lumped model contains only one cell, while a semi distributed model contains several cells (one for every subatchment). This leads to a more difficult construction and parametrization of the semi distributed model. The most straightforward way to adress this, is to split the code in severall classes. The main model class calls all the other classes and has the interface to Spotpy (or handles the manual calibration). The second class is a kind of template for a cell. In this class all CMF elements which are the same for all subcatchments are defined. This class inherits then to the classes of the several subcatchments. In those classes for the subcatchments all CMF elements are added which are different to the other subcatchments. This is also a good place to add the weather data for the subcatchments.</p>
<p>Important: In lumped models with a cell area other than 1000 m² and especially in semi distributed models, where every cell has another size, some parameters need to be adjusted for the size of the cell. Examples would be V0 in the PowerLaw or ETV1 in the evapotranspiration.</p>
<p>Following is a example how one might construct a semi distributed model. The example allows the user to choose the amount of cells in the model. All cells here use the same data and parameters. This would have to be changed for other usage.</p>
<p>The model itself and its driving data are attached to this site.</p>
<div class="fragment"><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div>
<div class="line"><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">Created on Jan 09 10:39 2018</span></div>
<div class="line"><span class="stringliteral">@author(s): Florian U. Jehn</span></div>
<div class="line"><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">import</span> datetime</div>
<div class="line"><span class="keyword">import</span> cmf</div>
<div class="line"><span class="keyword">import</span> spotpy</div>
<div class="line"><span class="keyword">from</span> spotpy.parameter <span class="keyword">import</span> Uniform</div>
<div class="line"><span class="keyword">import</span> os</div>
<div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ScalingTester:</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">    A class to determine how CMF handles different amounts of cells. To test</span></div>
<div class="line"><span class="stringliteral">    this the same model structure is run as a 1, 2, 4 and 8 cell layout. Each</span></div>
<div class="line"><span class="stringliteral">    cell has the same structure and parameters.</span></div>
<div class="line"><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line">    <span class="comment"># Catchment area km²</span></div>
<div class="line">    area = 562.41</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># General storage parameter</span></div>
<div class="line">    V0_L1 = Uniform(10, 300)</div>
<div class="line">    V0_L2 = Uniform(10, 300)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># ET parameter</span></div>
<div class="line">    fETV1 = Uniform(0.01, 1, doc=<span class="stringliteral">&#39;if V&lt;fETV1*V0, water uptake stress for &#39;</span></div>
<div class="line">                    <span class="stringliteral">&#39;plants starts [%]&#39;</span>)</div>
<div class="line">    fETV0 = Uniform(0, 0.9, doc=<span class="stringliteral">&#39;if V&lt;fETV0*fETV1*V0, plants die of drought &#39;</span></div>
<div class="line">                                <span class="stringliteral">&#39;[%]&#39;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Outflow parameters</span></div>
<div class="line">    tr_L1_out = Uniform(0.1, 200, doc=<span class="stringliteral">&#39;Residence time of water in storage &#39;</span></div>
<div class="line">                                      <span class="stringliteral">&#39;when &#39;</span></div>
<div class="line">                    <span class="stringliteral">&#39;V=V0 [days]&#39;</span>)</div>
<div class="line">    tr_L1_L2 = Uniform(0.1, 200)</div>
<div class="line">    tr_L2_out = Uniform(0.1, 200)</div>
<div class="line"> </div>
<div class="line">    beta_L1_out = Uniform(0.5, 4, doc=<span class="stringliteral">&quot;Exponent for scaling the outflow[]&quot;</span>)</div>
<div class="line">    beta_L1_L2 = Uniform(0.5, 4)</div>
<div class="line">    beta_L2_out = Uniform(0.4, 4)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Snow parameters</span></div>
<div class="line">    snow_meltrate = Uniform(3, 10, doc=<span class="stringliteral">&quot;Meltrate of the snow [(mm*degC)/day]&quot;</span>)     snow_melt_temp = Uniform(0, 3.5, doc=<span class="stringliteral">&quot;Temperature at which the snow [degC]&quot;</span></div>
<div class="line">                             <span class="stringliteral">&quot;melts&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Canopy Parameters</span></div>
<div class="line">    LAI = Uniform(1, 12, doc=<span class="stringliteral">&quot;Leaf Area Index&quot;</span>)</div>
<div class="line">    CanopyClosure = Uniform(0.1, 0.9, doc=<span class="stringliteral">&quot;Closure of the Canopy [%]&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>__init__(self, begin=None, end=None, num_cells=None):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Initializes the model.</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">        :param begin: Start year for the calibration</span></div>
<div class="line"><span class="stringliteral">        :param end: Stop year</span></div>
<div class="line"><span class="stringliteral">        :param num_cells: Number of cells used for this layout</span></div>
<div class="line"><span class="stringliteral">        :return: None</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        self.dbname = <span class="stringliteral">&quot;scaling_tester_num_cells_&quot;</span> + str(num_cells)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># load driver data</span></div>
<div class="line">        self.data = DataProvider(<span class="stringliteral">&quot;fulda_kaemmerzell_climate_79_89.csv&quot;</span>)</div>
<div class="line">        <span class="comment"># Create cells and project</span></div>
<div class="line">        self.project, self.outlet = self.create_project()</div>
<div class="line">        self.num_cells = num_cells</div>
<div class="line">        self.cells = self.create_cells()</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Add the data and set the parameters with random value, so the</span></div>
<div class="line">        <span class="comment"># complete structure can be described.</span></div>
<div class="line">        self.data.add_stations(self.project)</div>
<div class="line">        self.begin = begin <span class="keywordflow">or</span> self.data.begin</div>
<div class="line">        self.end = end <span class="keywordflow">or</span> self.data.end</div>
<div class="line">        self.setparameters()</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>create_project(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Creates and CMF project with an outlet and other basic stuff and</span></div>
<div class="line"><span class="stringliteral">        returns it.</span></div>
<div class="line"><span class="stringliteral">        :return: cmf project and cmf outlet</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># Use only a single thread, that is better for a calibration run and</span></div>
<div class="line">        <span class="comment"># for small models</span></div>
<div class="line">        cmf.set_parallel_threads(1)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># make the project</span></div>
<div class="line">        p = <a class="code hl_class" href="classcmf_1_1project.html">cmf.project</a>()</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># make the outlet</span></div>
<div class="line">        outlet = p.NewOutlet(<span class="stringliteral">&quot;outlet&quot;</span>, 10, 0, 0)</div>
<div class="line">        <span class="keywordflow">return</span> p, outlet</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>create_cells(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Creates a &#39;num_cells&#39; amount of cells for the project</span></div>
<div class="line"><span class="stringliteral">        :return:</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># Adjust the cellsize to the amount of cells</span></div>
<div class="line">        area = self.area / self.num_cells</div>
<div class="line">        <span class="comment"># Create all the cells!</span></div>
<div class="line">        cells = []</div>
<div class="line">        <span class="keywordflow">for</span> num <span class="keywordflow">in</span> range(self.num_cells):</div>
<div class="line">            cells.append(CellTemplate(self.project, self.outlet, area,</div>
<div class="line">                                      num))</div>
<div class="line">        <span class="keywordflow">return</span> cells</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>setparameters(self, par=None):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Sets the parameters for all cells seperately</span></div>
<div class="line"><span class="stringliteral">        :return:</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># Create tje parameters</span></div>
<div class="line">        par = par <span class="keywordflow">or</span> spotpy.parameter.create_set(self)</div>
<div class="line">        <span class="comment"># Call all cells</span></div>
<div class="line">        <span class="keywordflow">for</span> cell <span class="keywordflow">in</span> self.cells:</div>
<div class="line">            cell.set_parameters(par)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>runmodel(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Runs the models and saves the results.</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">        :return: Simulated discharge</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        solver = cmf.CVodeKrylov(self.project, 1e-9)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Result timeseries</span></div>
<div class="line">        res_q = cmf.timeseries(self.begin, cmf.day)</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">try</span>:</div>
<div class="line">            <span class="comment"># Start solver and calculate in daily steps</span></div>
<div class="line">            <span class="keywordflow">for</span> t <span class="keywordflow">in</span> solver.run(self.data.begin, self.end, cmf.day):</div>
<div class="line">                res_q.add(self.outlet.waterbalance(t))</div>
<div class="line">        <span class="keywordflow">except</span> RuntimeError:</div>
<div class="line">            <span class="keywordflow">return</span> np.array(self.data.Q[</div>
<div class="line">                            self.data.begin:self.data.end + datetime.timedelta(</div>
<div class="line">                                days=1)])*np.nan</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> res_q</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>simulation(self, vector=None):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Sets the parameters of the model and starts a run</span></div>
<div class="line"><span class="stringliteral">        :return: np.array with runoff in mm/day</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        self.setparameters(vector)</div>
<div class="line">        result_q = self.runmodel()</div>
<div class="line">        result_q /= 86400</div>
<div class="line">        <span class="keywordflow">return</span> np.array(result_q[self.begin:self.end])</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>evaluation(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Returns the evaluation data&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">return</span> np.array(self.data.Q[self.begin:self.end])</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>objectivefunction(self, simulation, evaluation):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Calculates the objective function&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">return</span> spotpy.objectivefunctions.nashsutcliffe(evaluation, simulation)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>CellTemplate:</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">    Template, which provides</span></div>
<div class="line"><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line">    <span class="keyword">def </span>__init__(self, project, outlet, area, cell_num):</div>
<div class="line">        self.project = project</div>
<div class="line">        self.outlet = outlet</div>
<div class="line">        self.area = area</div>
<div class="line">        self.cell = self.project.NewCell(cell_num, 0, 0, area * 1e6)</div>
<div class="line">        self.basic_set_up()</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>basic_set_up(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Creates the basic storages, that are to be connected in set_parameters.</span></div>
<div class="line"><span class="stringliteral">        :return:</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># Add layers</span></div>
<div class="line">        self.cell.add_layer(2.0)</div>
<div class="line">        self.cell.add_layer(4.0)</div>
<div class="line">        <span class="comment"># Install a connection for the ET</span></div>
<div class="line">        cmf.HargreaveET(self.cell.layers[0], self.cell.transpiration)</div>
<div class="line">        <span class="comment"># Add Snow</span></div>
<div class="line">        self.cell.add_storage(<span class="stringliteral">&quot;Snow&quot;</span>, <span class="stringliteral">&quot;S&quot;</span>)</div>
<div class="line">        cmf.Snowfall(self.cell.snow, self.cell)</div>
<div class="line">        <span class="comment"># Create a storage for Interception</span></div>
<div class="line">        self.cell.add_storage(<span class="stringliteral">&quot;Canopy&quot;</span>, <span class="stringliteral">&quot;C&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>set_parameters(self, par):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Sets the parameters for a cell instance</span></div>
<div class="line"><span class="stringliteral">        :param par: Object with all parameters</span></div>
<div class="line"><span class="stringliteral">        :return: None</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        c = self.cell</div>
<div class="line">        out = self.outlet</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Scale to the cellsize</span></div>
<div class="line">        V0_L1 = (par.V0_L1 / 1000) * self.area * 1e6</div>
<div class="line">        V0_L2 = (par.V0_L2 / 1000) * self.area * 1e6</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Set uptake stress</span></div>
<div class="line">        ETV1 = par.fETV1 * V0_L1</div>
<div class="line">        ETV0 = par.fETV0 * ETV1</div>
<div class="line">        c.set_uptakestress(cmf.VolumeStress(ETV1, ETV0))</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Connect layer and outlet</span></div>
<div class="line">        cmf.PowerLawConnection(c.layers[0], out, Q0=V0_L1 / par.tr_L1_out,</div>
<div class="line">                               V0=V0_L1,</div>
<div class="line">                               beta=par.beta_L1_out)</div>
<div class="line"> </div>
<div class="line">        cmf.PowerLawConnection(c.layers[0], c.layers[1], Q0=(V0_L1 /</div>
<div class="line">                                                            par.tr_L1_L2),</div>
<div class="line">                               V0=V0_L1, beta=par.beta_L1_L2)</div>
<div class="line">        cmf.PowerLawConnection(c.layers[1], out, Q0=V0_L2 / par.tr_L2_out,</div>
<div class="line">                               V0=V0_L2,</div>
<div class="line">                               beta=par.beta_L2_out)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Snow</span></div>
<div class="line">        cmf.TempIndexSnowMelt(c.snow, c.layers[0], c,</div>
<div class="line">                                 rate=par.snow_meltrate)</div>
<div class="line">        cmf.Weather.set_snow_threshold(par.snow_melt_temp)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Split the rainfall in interception and throughfall</span></div>
<div class="line">        cmf.Rainfall(c.canopy, c, <span class="keyword">False</span>, <span class="keyword">True</span>)</div>
<div class="line">        cmf.Rainfall(c.surfacewater, c, <span class="keyword">True</span>, <span class="keyword">False</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Make an overflow for the interception storage</span></div>
<div class="line">        cmf.RutterInterception(c.canopy, c.surfacewater, c)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Transpiration from the plants is added</span></div>
<div class="line">        cmf.CanopyStorageEvaporation(c.canopy, c.evaporation, c)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Sets the paramaters for interception</span></div>
<div class="line">        c.vegetation.LAI = par.LAI</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Defines how much throughfall there is (in %)</span></div>
<div class="line">        c.vegetation.CanopyClosure = par.CanopyClosure</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DataProvider:</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">    Holds the forcing and calibration data</span></div>
<div class="line"><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line">    <span class="keyword">def </span>__init__(self, file_name):</div>
<div class="line">        <span class="comment"># Load data from file using numpy magic</span></div>
<div class="line">        data = pd.read_csv(file_name, encoding=<span class="stringliteral">&quot;ISO-8859-1&quot;</span>, sep=<span class="stringliteral">&quot;;&quot;</span>)</div>
<div class="line">        <span class="comment"># Delete first row, as it only contains the units</span></div>
<div class="line">        data = data.iloc[1:]</div>
<div class="line">        data = data.dropna(axis=0)</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">def </span>bstr2date(bs):</div>
<div class="line">            <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">            Helper function to convert date byte string to datetime object</span></div>
<div class="line"><span class="stringliteral">            &quot;&quot;&quot;</span></div>
<div class="line">            <span class="keywordflow">return</span> datetime.datetime.strptime(bs, <span class="stringliteral">&#39;%d.%m.%Y&#39;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Get begin, step and end from the date column</span></div>
<div class="line">        self.begin = bstr2date(data[<span class="stringliteral">&quot;date&quot;</span>].iloc[0])         self.step = bstr2date(data[<span class="stringliteral">&quot;date&quot;</span>]].iloc[1) - self.begin</div>
<div class="line">        self.end = bstr2date(data[<span class="stringliteral">&quot;date&quot;</span>].iloc[-1])</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Read in the data</span></div>
<div class="line">        self.P = cmf.timeseries.from_sequence(self.begin, self.step,</div>
<div class="line">                                              data[<span class="stringliteral">&quot;Prec&quot;</span>])</div>
<div class="line">        self.T = cmf.timeseries.from_sequence(self.begin, self.step,</div>
<div class="line">                                              data[<span class="stringliteral">&quot;tmean&quot;</span>])</div>
<div class="line">        self.Tmin = cmf.timeseries.from_sequence(self.begin, self.step,</div>
<div class="line">                                                 data[<span class="stringliteral">&quot;tmin&quot;</span>])</div>
<div class="line">        self.Tmax = cmf.timeseries.from_sequence(self.begin, self.step,</div>
<div class="line">                                                 data[<span class="stringliteral">&quot;tmax&quot;</span>])</div>
<div class="line">        self.Q = cmf.timeseries.from_sequence(self.begin, self.step,</div>
<div class="line">                                              data[<span class="stringliteral">&quot;Q&quot;</span>])</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>add_stations(self, project):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="stringliteral">        Creates a rainstation and a meteo station for the cmf project</span></div>
<div class="line"><span class="stringliteral">        :param project: A cmf.project</span></div>
<div class="line"><span class="stringliteral">        :return: rainstation, meteo</span></div>
<div class="line"><span class="stringliteral">        &quot;&quot;&quot;</span></div>
<div class="line">        rainstation = project.rainfall_stations.add(<span class="stringliteral">&#39;Kaemmerzell avg&#39;</span>, self.P,</div>
<div class="line">                                                    (0, 0, 0))</div>
<div class="line"> </div>
<div class="line">        project.use_nearest_rainfall()</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Temperature data</span></div>
<div class="line">        meteo = project.meteo_stations.add_station(<span class="stringliteral">&#39;Kaemmerzell avg&#39;</span>,</div>
<div class="line">                                                   (0, 0, 0))</div>
<div class="line">        meteo.T = self.T</div>
<div class="line">        meteo.Tmin = self.Tmin</div>
<div class="line">        meteo.Tmax = self.Tmax</div>
<div class="line"> </div>
<div class="line">        project.use_nearest_meteo()</div>
<div class="line">        <span class="keywordflow">return</span> rainstation, meteo</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div>
<div class="line">    <span class="comment"># Get sampler</span></div>
<div class="line">    <span class="keyword">from</span> spotpy.algorithms <span class="keyword">import</span> lhs <span class="keyword">as</span> Sampler</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Check if we are running on a supercomputer or local</span></div>
<div class="line">    parallel = <span class="stringliteral">&#39;mpi&#39;</span> <span class="keywordflow">if</span> <span class="stringliteral">&#39;OMPI_COMM_WORLD_SIZE&#39;</span> <span class="keywordflow">in</span> os.environ <span class="keywordflow">else</span> <span class="stringliteral">&#39;seq&#39;</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Run the models</span></div>
<div class="line">    runs = 100</div>
<div class="line">    num_cells = [1, 2, 4, 8]</div>
<div class="line">    results = {}</div>
<div class="line">    <span class="keywordflow">for</span> num <span class="keywordflow">in</span> num_cells:</div>
<div class="line">        <span class="comment"># Create the model</span></div>
<div class="line">        model = ScalingTester(num_cells=num)</div>
<div class="line">        print(cmf.describe(model.project))</div>
<div class="line">        <span class="comment"># Create the sampler</span></div>
<div class="line">        sampler = Sampler(model, parallel=parallel, dbname=model.dbname,</div>
<div class="line">                          dbformat=<span class="stringliteral">&#39;csv&#39;</span>, save_sim=<span class="keyword">False</span>)</div>
<div class="line"> </div>
<div class="line">        sampler.sample(runs)</div>
<div class="line">        results[str(num)] = sampler.status.objectivefunction</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> results.items():</div>
<div class="line">        print(<span class="stringliteral">&quot;The model with {} cell(s) has a best NS of {}&quot;</span>.format(</div>
<div class="line">                                                                    key,</div>
<div class="line">                                                                    value))</div>
<div class="ttc" id="aclasscmf_1_1project_html"><div class="ttname"><a href="classcmf_1_1project.html">cmf::project</a></div><div class="ttdoc">The study area, holding all cells, outlets and streams.</div><div class="ttdef"><b>Definition</b> project.h:53</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<hr class="footer"/><address class="footer"><small>
<div>&copy 2008-2017 by 
<a class="el" href="http://www.uni-giessen.de/hydro/kraft"> Philipp Kraft</a> and
<a class="el" href="http://www.uni-giessen.de/hydro"> 
Institute of Landscape Ecology and Resources Management,University of Gie&szlig;en</a>
</h3></td>
<td>Generated: Fri Jan 19 2024 16:10:56</td>
</tr></table>
</small></address>
</body>
</html>
